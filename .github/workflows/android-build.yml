name: Build Vyakti AI React Native App

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 11076708
        packages: "platform-tools platforms;android-35 build-tools;35.0.0 ndk;25.1.8937393"

    - name: Verify Project Structure
      run: |
        echo "=== Vyakti AI Project Verification ==="
        ls -la
        echo ""
        echo "Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"
        echo "Android directory: $(test -d android && echo 'YES' || echo 'NO')"
        echo "App.js/App.tsx: $(test -f App.js -o -f App.tsx && echo 'YES' || echo 'NO')"

    - name: Install React Native Dependencies
      run: |
        echo "Installing dependencies with npm install..."
        npm install --legacy-peer-deps
        echo "Dependencies installed successfully"

    - name: Create Android Configuration
      run: |
        echo "sdk.dir=$ANDROID_HOME" > android/local.properties
        echo "Android local.properties created"

    - name: Setup Gradle Wrapper
      run: |
        cd android
        chmod +x gradlew
        
        mkdir -p gradle/wrapper
        
        # Download gradle-wrapper.jar
        if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
          curl -L -o gradle/wrapper/gradle-wrapper.jar https://github.com/gradle/gradle/raw/v8.1.1/gradle/wrapper/gradle-wrapper.jar
        fi
        
        # Create gradle-wrapper.properties
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.1.1-bin.zip
        networkTimeout=10000
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF

    - name: Configure Gradle Properties
      run: |
        cd android
        echo "" >> gradle.properties
        echo "# React Native Build Configuration" >> gradle.properties
        echo "org.gradle.jvmargs=-Xmx4096M -XX:MaxMetaspaceSize=512m" >> gradle.properties
        echo "android.useAndroidX=true" >> gradle.properties
        echo "android.enableJetifier=true" >> gradle.properties
        echo "hermesEnabled=true" >> gradle.properties
        echo "org.gradle.daemon=false" >> gradle.properties

    - name: Test Gradle
      working-directory: android
      run: |
        echo "Testing Gradle wrapper..."
        ./gradlew --version

    - name: Clean Build
      working-directory: android
      run: ./gradlew clean --no-daemon --stacktrace

    - name: Build Debug APK
      working-directory: android
      run: ./gradlew assembleDebug --no-daemon --stacktrace

    - name: Build Release APK
      working-directory: android
      run: ./gradlew assembleRelease --no-daemon --stacktrace

    - name: Build Release AAB
      working-directory: android
      run: ./gradlew bundleRelease --no-daemon --stacktrace

    - name: List Build Outputs
      run: |
        echo "=== Build Results ==="
        find android/app/build/outputs -name "*.apk" -o -name "*.aab" | sort

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-debug
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-release
        path: android/app/build/outputs/apk/release/*.apk
        retention-days: 14

    - name: Upload Play Store AAB
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-playstore
        path: android/app/build/outputs/bundle/release/*.aab
        retention-days: 30

    - name: Success Summary
      run: |
        echo "✅ Vyakti AI React Native app built successfully!"
        echo "✅ Debug APK ready for testing"
        echo "✅ Release APK ready for distribution" 
        echo "✅ AAB ready for Play Store submission"
