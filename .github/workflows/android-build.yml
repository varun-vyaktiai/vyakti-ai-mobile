name: Build Vyakti AI Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 35
        build-tools: 35.0.0
        ndk-version: 25.1.8937393

    - name: Create Android local.properties
      run: echo "sdk.dir=$ANDROID_HOME" > android/local.properties

    - name: Fix android/build.gradle - Add missing repositories
      run: |
        echo "Original build.gradle:"
        cat android/build.gradle
        
        # Add repositories to buildscript block
        sed -i '/buildscript {/,/dependencies {/ {
          /dependencies {/i\    repositories {\
\        google()\
\        mavenCentral()\
\        maven { url "https://www.jitpack.io" }\
\    }
        }' android/build.gradle
        
        echo "Updated build.gradle:"
        cat android/build.gradle

    - name: Fix android/app/build.gradle - Set entryFile as file
      run: |
        echo "Fixing entryFile type for React Native 0.73.6..."
        sed -i 's/entryFile = "index.js"/entryFile = file("..\/index.js")/' android/app/build.gradle
        
        echo "After fix:"
        head -15 android/app/build.gradle

    - name: Make gradlew executable
      run: chmod +x android/gradlew

    - name: Clean project
      run: cd android && ./gradlew clean

    - name: Build Release APK
      run: cd android && ./gradlew assembleRelease

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-release-apk
        path: android/app/build/outputs/apk/release/app-release.apk
        retention-days: 30

    - name: Build Release AAB (Android App Bundle)
      run: cd android && ./gradlew bundleRelease

    - name: Upload AAB
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-release-aab
        path: android/app/build/outputs/bundle/release/app-release.aab
        retention-days: 30

    - name: Display build summary
      run: |
        echo "ðŸŽ‰ Build completed successfully!"
        echo "ðŸ“± APK: android/app/build/outputs/apk/release/app-release.apk"
        echo "ðŸ“¦ AAB: android/app/build/outputs/bundle/release/app-release.aab"
        echo ""
        echo "Build details:"
        echo "- React Native: 0.73.6"
        echo "- Target SDK: 35 (Android 15)"
        echo "- Min SDK: 24"
        echo "- App ID: com.vyaktiai.mobile"
        echo "- Ready for Google Play Store submission"
