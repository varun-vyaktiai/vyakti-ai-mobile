name: Build Vyakti AI React Native App

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 11076708
        packages: "platform-tools platforms;android-35 build-tools;35.0.0 ndk;25.1.8937393"

    - name: Install React Native Dependencies
      run: npm install --legacy-peer-deps

    - name: Create Android Configuration
      run: echo "sdk.dir=$ANDROID_HOME" > android/local.properties

    - name: Install Gradle Directly (Bypass Wrapper Issues)
      run: |
        echo "Installing Gradle directly to bypass wrapper corruption..."
        cd /opt
        sudo wget -q https://services.gradle.org/distributions/gradle-8.1.1-bin.zip
        sudo unzip -q gradle-8.1.1-bin.zip
        sudo rm gradle-8.1.1-bin.zip
        sudo ln -sf /opt/gradle-8.1.1/bin/gradle /usr/local/bin/gradle
        gradle --version
        echo "✅ Gradle installed successfully"

    - name: Configure Gradle Properties
      run: |
        cd android
        echo "" >> gradle.properties
        echo "# React Native Build Configuration" >> gradle.properties
        echo "org.gradle.jvmargs=-Xmx4096M -XX:MaxMetaspaceSize=512m" >> gradle.properties
        echo "android.useAndroidX=true" >> gradle.properties
        echo "android.enableJetifier=true" >> gradle.properties
        echo "hermesEnabled=true" >> gradle.properties
        echo "org.gradle.daemon=false" >> gradle.properties

    - name: Clean Build (Direct Gradle)
      working-directory: android
      run: gradle clean --no-daemon --stacktrace

    - name: Build Debug APK (Direct Gradle)
      working-directory: android
      run: gradle assembleDebug --no-daemon --stacktrace

    - name: Build Release APK (Direct Gradle)
      working-directory: android
      run: gradle assembleRelease --no-daemon --stacktrace

    - name: Build Release AAB (Direct Gradle)
      working-directory: android
      run: gradle bundleRelease --no-daemon --stacktrace

    - name: Verify Build Outputs
      run: |
        echo "=== Vyakti AI Build Results ==="
        find android/app/build/outputs -name "*.apk" -o -name "*.aab" | sort
        echo ""
        echo "=== File Details ==="
        for file in $(find android/app/build/outputs -name "*.apk" -o -name "*.aab"); do
          echo "File: $(basename $file)"
          echo "Size: $(du -h "$file" | cut -f1)"
          echo "---"
        done

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-debug-direct
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-release-direct
        path: android/app/build/outputs/apk/release/*.apk
        retention-days: 14

    - name: Upload Play Store AAB
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-playstore-direct
        path: android/app/build/outputs/bundle/release/*.aab
        retention-days: 30

    - name: Build Success
      run: |
        echo "✅ Vyakti AI React Native app built successfully!"
        echo "✅ Used direct Gradle installation to bypass wrapper issues"
        echo "✅ Your complete mobile app with all features is ready"
        echo "✅ Download APK from GitHub Actions artifacts"
        echo "✅ Install on Android phone for testing"
