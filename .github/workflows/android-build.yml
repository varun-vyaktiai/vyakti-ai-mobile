name: Build Vyakti AI React Native App

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 11076708
        packages: "platform-tools platforms;android-35 build-tools;35.0.0 ndk;25.1.8937393"

    - name: Install React Native Dependencies
      run: npm install --legacy-peer-deps

    - name: Fix React Native 0.73.6 Gradle Configuration
      run: |
        # Create local.properties
        echo "sdk.dir=$ANDROID_HOME" > android/local.properties
        
        # Fix build.gradle for React Native 0.73.6 compatibility
        cat > android/build.gradle << 'EOF'
        // Top-level build file where you can add configuration options common to all sub-projects/modules.

        buildscript {
            ext {
                buildToolsVersion = "35.0.0"
                minSdkVersion = 24
                compileSdkVersion = 35
                targetSdkVersion = 35
                ndkVersion = "25.1.8937393"
                kotlinVersion = "1.8.10"
            }
            repositories {
                google()
                mavenCentral()
                maven { url "https://www.jitpack.io" }
                maven { url "https://repo1.maven.org/maven2/" }
                gradlePluginPortal()
            }
            dependencies {
                classpath("com.android.tools.build:gradle:8.1.4")
                classpath("com.facebook.react:react-native-gradle-plugin")
                classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
            }
        }

        apply plugin: "com.facebook.react.rootproject"

        allprojects {
            repositories {
                google()
                mavenCentral()
                maven { url "https://www.jitpack.io" }
                maven { url "https://repo1.maven.org/maven2/" }
                gradlePluginPortal()
            }
        }
        EOF
        
        # Create proper gradle.properties for React Native 0.73.6
        cat > android/gradle.properties << 'EOF'
        # Project-wide Gradle settings
        org.gradle.jvmargs=-Xmx4096M -XX:MaxMetaspaceSize=512m
        org.gradle.daemon=false
        org.gradle.parallel=false
        
        # Android settings for React Native 0.73.6
        android.useAndroidX=true
        android.enableJetifier=true
        android.enableR8.fullMode=true
        
        # React Native settings
        hermesEnabled=true
        newArchEnabled=false
        
        # Flipper version for debug builds
        FLIPPER_VERSION=0.182.0
        EOF

    - name: Install Gradle 8.7 (Required for RN 0.73.6)
      run: |
        cd /opt
        sudo wget -q https://services.gradle.org/distributions/gradle-8.7-bin.zip
        sudo unzip -q gradle-8.7-bin.zip
        sudo rm gradle-8.7-bin.zip
        sudo ln -sf /opt/gradle-8.7/bin/gradle /usr/local/bin/gradle
        gradle --version

    - name: Create Debug Keystore
      working-directory: android/app
      run: |
        if [ ! -f debug.keystore ]; then
          keytool -genkeypair -v -keystore debug.keystore -alias androiddebugkey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"
        fi

    - name: Test Configuration
      working-directory: android
      run: |
        echo "Testing React Native 0.73.6 Gradle configuration..."
        gradle tasks --no-daemon --stacktrace

    - name: Clean Build
      working-directory: android
      run: gradle clean --no-daemon --stacktrace

    - name: Build Debug APK
      working-directory: android
      run: gradle assembleDebug --no-daemon --stacktrace

    - name: Build Release APK
      working-directory: android
      run: gradle assembleRelease --no-daemon --stacktrace

    - name: Build Release AAB
      working-directory: android
      run: gradle bundleRelease --no-daemon --stacktrace

    - name: Verify Build Results
      run: |
        echo "=== Vyakti AI React Native 0.73.6 Build Complete ==="
        find android/app/build/outputs -name "*.apk" -o -name "*.aab" | sort
        echo ""
        echo "=== Build Artifacts ==="
        for file in $(find android/app/build/outputs -name "*.apk" -o -name "*.aab"); do
          echo "$(basename $file): $(du -h "$file" | cut -f1)"
        done

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-debug-073
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-release-073
        path: android/app/build/outputs/apk/release/*.apk
        retention-days: 14

    - name: Upload Play Store AAB
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-playstore-073
        path: android/app/build/outputs/bundle/release/*.aab
        retention-days: 30

    - name: Build Success
      run: |
        echo "âœ… Vyakti AI React Native 0.73.6 app built successfully!"
        echo "âœ… Fixed React Native Gradle plugin compatibility"
        echo "âœ… Used correct Gradle 8.7 version for RN 0.73.6"
        echo "âœ… Generated production-ready APK and AAB files"
        echo ""
        echo "ðŸ“± Your complete mobile app is ready:"
        echo "â€¢ vyakti-ai-debug-073 (for testing)"
        echo "â€¢ vyakti-ai-release-073 (for distribution)"
        echo "â€¢ vyakti-ai-playstore-073 (for Google Play Store)"
