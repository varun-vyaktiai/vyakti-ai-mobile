name: Build Vyakti AI React Native 0.73.6 (Ultimate Fix)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 11076708
        packages: "platform-tools platforms;android-35 build-tools;35.0.0 ndk;25.1.8937393"

    - name: Install Gradle Directly (Bypass Corrupted Wrapper)
      run: |
        echo "Installing Gradle 8.1.1 directly to bypass wrapper issues..."
        wget -q https://services.gradle.org/distributions/gradle-8.1.1-bin.zip
        unzip -q gradle-8.1.1-bin.zip
        sudo mv gradle-8.1.1 /opt/gradle
        echo "export PATH=/opt/gradle/bin:\$PATH" >> $GITHUB_ENV
        export PATH=/opt/gradle/bin:$PATH
        gradle --version

    - name: Install React Native Dependencies
      run: npm install --legacy-peer-deps

    - name: Fix React Native 0.73.6 Complete Configuration
      run: |
        # Create local.properties
        echo "sdk.dir=$ANDROID_HOME" > android/local.properties
        
        # Create the complete React Native 0.73.6 build configuration
        # This includes BOTH the buildscript AND the React Native root project plugin
        cat > android/build.gradle << 'EOF'
        // Top-level build file where you can add configuration options common to all sub-projects/modules.

        buildscript {
            ext {
                buildToolsVersion = "35.0.0"
                minSdkVersion = 24
                compileSdkVersion = 35
                targetSdkVersion = 35
                ndkVersion = "25.1.8937393"
                kotlinVersion = "1.8.10"
            }
            repositories {
                google()
                mavenCentral()
                maven { url "https://www.jitpack.io" }
                maven { url "https://repo1.maven.org/maven2/" }
            }
            dependencies {
                classpath("com.android.tools.build:gradle:8.1.1")
                classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
                // NOTE: React Native 0.73.6 has built-in gradle plugin, no classpath needed
            }
        }

        // CRITICAL: Apply the React Native root project plugin
        apply plugin: "com.facebook.react.rootproject"

        allprojects {
            repositories {
                google()
                mavenCentral()
                maven { url "https://www.jitpack.io" }
                maven { url "https://repo1.maven.org/maven2/" }
            }
        }
        EOF
        
        # Create proper gradle.properties
        cat > android/gradle.properties << 'EOF'
        # Project-wide Gradle settings
        org.gradle.jvmargs=-Xmx4096M -XX:MaxMetaspaceSize=512m
        org.gradle.daemon=false
        org.gradle.parallel=false
        
        # Android settings
        android.useAndroidX=true
        android.enableJetifier=true
        android.enableR8.fullMode=true
        
        # React Native settings
        hermesEnabled=true
        newArchEnabled=false
        
        # Flipper version
        FLIPPER_VERSION=0.182.0
        EOF

    - name: Create Debug Keystore
      working-directory: android/app
      run: |
        if [ ! -f debug.keystore ]; then
          keytool -genkeypair -v -keystore debug.keystore -alias androiddebugkey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"
        fi

    - name: Test Configuration (Complete React Native Setup)
      working-directory: android
      run: |
        echo "Testing React Native 0.73.6 with complete configuration..."
        export PATH=/opt/gradle/bin:$PATH
        gradle tasks --no-daemon --stacktrace

    - name: Clean Build
      working-directory: android
      run: |
        export PATH=/opt/gradle/bin:$PATH
        gradle clean --no-daemon --stacktrace

    - name: Build Debug APK
      working-directory: android
      run: |
        export PATH=/opt/gradle/bin:$PATH
        gradle assembleDebug --no-daemon --stacktrace

    - name: Build Release APK
      working-directory: android
      run: |
        export PATH=/opt/gradle/bin:$PATH
        gradle assembleRelease --no-daemon --stacktrace

    - name: Build Release AAB
      working-directory: android
      run: |
        export PATH=/opt/gradle/bin:$PATH
        gradle bundleRelease --no-daemon --stacktrace

    - name: Verify Build Results
      run: |
        echo "=== Vyakti AI React Native 0.73.6 Build Complete ==="
        find android/app/build/outputs -name "*.apk" -o -name "*.aab" | sort
        echo ""
        echo "=== Build Artifacts ==="
        for file in $(find android/app/build/outputs -name "*.apk" -o -name "*.aab"); do
          echo "$(basename $file): $(du -h "$file" | cut -f1)"
        done

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-debug-ultimate
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-release-ultimate
        path: android/app/build/outputs/apk/release/*.apk
        retention-days: 14

    - name: Upload Play Store AAB
      uses: actions/upload-artifact@v4
      with:
        name: vyakti-ai-playstore-ultimate
        path: android/app/build/outputs/bundle/release/*.aab
        retention-days: 30

    - name: Build Success
      run: |
        echo "âœ… Vyakti AI React Native 0.73.6 app built successfully!"
        echo "âœ… Fixed missing React Native root project plugin"
        echo "âœ… Used direct Gradle installation (bypassed corrupted wrapper)"
        echo "âœ… Complete React Native 0.73.6 build configuration applied"
        echo "âœ… Generated production-ready APK and AAB files"
        echo ""
        echo "ðŸ“± Your complete mobile app is ready:"
        echo "â€¢ vyakti-ai-debug-ultimate (for testing)"
        echo "â€¢ vyakti-ai-release-ultimate (for distribution)"  
        echo "â€¢ vyakti-ai-playstore-ultimate (for Google Play Store)"
