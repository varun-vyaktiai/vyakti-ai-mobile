name: Build Vyakti AI Mobile App

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 11076708
        packages: "platform-tools platforms;android-35 build-tools;35.0.0 ndk;25.1.8937393"

    - name: Verify mobile app directory exists
      run: |
        echo "=== Repository structure ==="
        ls -la
        echo "=== Mobile app directory ==="
        ls -la mobile-app/
        echo "=== Mobile app package.json ==="
        cat mobile-app/package.json

    - name: Generate package-lock.json if missing
      working-directory: mobile-app
      run: |
        if [ ! -f package-lock.json ]; then
          echo "Creating missing package-lock.json..."
          npm install --package-lock-only --legacy-peer-deps
        fi

    - name: Install React Native dependencies
      working-directory: mobile-app
      run: npm ci --legacy-peer-deps

    - name: Create Android local.properties
      working-directory: mobile-app
      run: echo "sdk.dir=$ANDROID_HOME" > android/local.properties

    - name: Fix Android Gradle configuration
      working-directory: mobile-app/android
      run: |
        
        # Ensure gradle wrapper exists and is executable
        if [ ! -f gradlew ]; then
          echo "Creating Gradle wrapper..."
          curl -L -o gradle.zip https://services.gradle.org/distributions/gradle-8.1.1-bin.zip
          unzip -q gradle.zip
          sudo rm -rf /opt/gradle 2>/dev/null || true
          sudo mv gradle-8.1.1 /opt/gradle
          sudo chmod +x /opt/gradle/bin/gradle
          /opt/gradle/bin/gradle wrapper --gradle-version 8.1.1
        fi
        chmod +x gradlew
        
        # Update gradle.properties for React Native
        echo "" >> gradle.properties
        echo "# React Native optimization settings" >> gradle.properties  
        echo "org.gradle.jvmargs=-Xmx4096M -Dkotlin.daemon.jvm.options=\"-Xmx4096M\"" >> gradle.properties
        echo "android.useAndroidX=true" >> gradle.properties
        echo "android.enableJetifier=true" >> gradle.properties
        echo "hermesEnabled=true" >> gradle.properties

    - name: Clean previous builds
      working-directory: mobile-app/android
      run: ./gradlew clean --no-daemon --stacktrace

    - name: Build Debug APK
      working-directory: mobile-app/android
      run: ./gradlew assembleDebug --no-daemon --stacktrace

    - name: Build Release APK
      working-directory: mobile-app/android
      run: ./gradlew assembleRelease --no-daemon --stacktrace

    - name: Build Release AAB for Play Store
      working-directory: mobile-app/android
      run: ./gradlew bundleRelease --no-daemon --stacktrace

    - name: Verify build outputs
      run: |
        echo "=== Vyakti AI Mobile App Build Results ==="
        find mobile-app/android/app/build/outputs -name "*.apk" -o -name "*.aab" | sort
        echo ""
        echo "=== File Details ==="
        for file in $(find mobile-app/android/app/build/outputs -name "*.apk" -o -name "*.aab"); do
          echo "File: $(basename $file)"
          echo "Path: $file"  
          echo "Size: $(du -h "$file" | cut -f1)"
          echo "---"
        done

    - name: Upload Debug APK - Vyakti AI
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: vyakti-ai-mobile-debug-apk
        path: mobile-app/android/app/build/outputs/apk/debug/*.apk
        retention-days: 7

    - name: Upload Release APK - Vyakti AI  
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: vyakti-ai-mobile-release-apk
        path: mobile-app/android/app/build/outputs/apk/release/*.apk
        retention-days: 14

    - name: Upload Release AAB - Play Store Ready
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: vyakti-ai-mobile-aab-playstore
        path: mobile-app/android/app/build/outputs/bundle/release/*.aab
        retention-days: 30

    - name: Vyakti AI Mobile Build Success
      run: |
        echo "✅ Vyakti AI mobile app build completed successfully!"
        echo "✅ Your full-featured React Native app is now built"
        echo "✅ APK contains all your app screens, features, and functionality"
        echo "✅ Download artifacts from GitHub Actions tab"
        echo "✅ Test debug APK on Android phone before Play Store submission"
        echo "✅ Use AAB file for Google Play Store upload"
