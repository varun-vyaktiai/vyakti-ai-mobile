name: Build Vyakti AI Mobile App

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 11076708
        packages: "platform-tools platforms;android-35 build-tools;35.0.0 ndk;25.1.8937393"

    - name: Verify React Native project structure
      run: |
        echo "=== React Native Project Structure ==="
        ls -la
        echo "=== Package.json content ==="
        cat package.json
        echo "=== Android directory ==="
        ls -la android/

    - name: Generate package-lock.json if missing
      run: |
        if [ ! -f package-lock.json ]; then
          echo "Creating package-lock.json..."
          npm install --package-lock-only --legacy-peer-deps
        fi

    - name: Install React Native dependencies
      run: npm ci --legacy-peer-deps

    - name: Create Android local.properties
      run: echo "sdk.dir=$ANDROID_HOME" > android/local.properties

    - name: Fix Android Gradle configuration
      working-directory: android
      run: |
        # Ensure gradle wrapper exists and is executable
        if [ ! -f gradlew ]; then
          echo "Creating Gradle wrapper..."
          curl -L -o gradle.zip https://services.gradle.org/distributions/gradle-8.1.1-bin.zip
          unzip -q gradle.zip
          sudo rm -rf /opt/gradle 2>/dev/null || true
          sudo mv gradle-8.1.1 /opt/gradle
          sudo chmod +x /opt/gradle/bin/gradle
          /opt/gradle/bin/gradle wrapper --gradle-version 8.1.1
        fi
        chmod +x gradlew
        
        # Update gradle.properties for React Native
        echo "" >> gradle.properties
        echo "# React Native optimization settings" >> gradle.properties  
        echo "org.gradle.jvmargs=-Xmx4096M -Dkotlin.daemon.jvm.options=\"-Xmx4096M\"" >> gradle.properties
        echo "android.useAndroidX=true" >> gradle.properties
        echo "android.enableJetifier=true" >> gradle.properties
        echo "hermesEnabled=true" >> gradle.properties

    - name: Clean previous builds
      working-directory: android
      run: ./gradlew clean --no-daemon --stacktrace

    - name: Build Debug APK
      working-directory: android
      run: ./gradlew assembleDebug --no-daemon --stacktrace

    - name: Build Release APK
      working-directory: android
      run: ./gradlew assembleRelease --no-daemon --stacktrace

    - name: Build Release AAB for Play Store
      working-directory: android
      run: ./gradlew bundleRelease --no-daemon --stacktrace

    - name: Verify build outputs
      run: |
        echo "=== Vyakti AI Build Results ==="
        find android/app/build/outputs -name "*.apk" -o -name "*.aab" | sort
        echo ""
        echo "=== File Details ==="
        for file in $(find android/app/build/outputs -name "*.apk" -o -name "*.aab"); do
          echo "File: $(basename $file)"
          echo "Path: $file"  
          echo "Size: $(du -h "$file" | cut -f1)"
          echo "---"
        done

    - name: Upload Debug APK - Vyakti AI
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: vyakti-ai-debug-apk-final
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7

    - name: Upload Release APK - Vyakti AI  
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: vyakti-ai-release-apk-final
        path: android/app/build/outputs/apk/release/*.apk
        retention-days: 14

    - name: Upload Release AAB - Play Store Ready
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: vyakti-ai-aab-playstore-final
        path: android/app/build/outputs/bundle/release/*.aab
        retention-days: 30

    - name: Vyakti AI Build Success
      run: |
        echo "✅ Vyakti AI mobile app build completed successfully!"
        echo "✅ Built from vyakti-ai-mobile-final-fixed repository"
        echo "✅ Your complete React Native app with all features"
        echo "✅ Download artifacts from GitHub Actions tab"
        echo "✅ Test debug APK on Android phone before Play Store submission"
        echo "✅ Use AAB file for Google Play Store upload"
